<?php

declare(strict_types=1);

namespace ReportedIp\Honeypot\Detection\Analyzers;

use ReportedIp\Honeypot\Core\Request;
use ReportedIp\Honeypot\Detection\AnalyzerInterface;
use ReportedIp\Honeypot\Detection\DetectionResult;
use ReportedIp\Honeypot\Detection\PatternLibrary;

/**
 * Detects attempts to exploit known CMS plugin/theme vulnerabilities.
 *
 * Covers WordPress plugin exploits (RevSlider, WP File Manager, Duplicator, etc.),
 * Drupal module exploits (Drupalgeddon), and Joomla component exploits.
 */
final class PluginExploitAnalyzer implements AnalyzerInterface
{
    public function getName(): string
    {
        return 'PluginExploit';
    }

    public function analyze(Request $request): ?DetectionResult
    {
        $path = $request->getPath();
        $uri = $request->getUri();

        if ($path === '' || $path === '/') {
            return null;
        }

        $findings = [];
        $maxScore = 0;

        $exploitPatterns = PatternLibrary::pluginExploitPaths();

        foreach ($exploitPatterns as $pattern) {
            if (preg_match($pattern, $uri)) {
                $description = $this->describeExploit($pattern);
                $score = $this->scoreExploit($pattern);
                $findings[] = $description;
                $maxScore = max($maxScore, $score);
            }
        }

        // Additional context-aware checks
        $this->checkWordPressSpecific($request, $findings, $maxScore);
        $this->checkDrupalSpecific($request, $findings, $maxScore);
        $this->checkJoomlaSpecific($request, $findings, $maxScore);

        if (empty($findings)) {
            return null;
        }

        $comment = sprintf(
            'CMS plugin/theme exploit attempt: %s (path: %s)',
            implode('; ', array_slice(array_unique($findings), 0, 3)),
            substr($path, 0, 200)
        );

        return new DetectionResult([35, 57], $comment, $maxScore, $this->getName());
    }

    private function checkWordPressSpecific(Request $request, array &$findings, int &$maxScore): void
    {
        $path = $request->getPath();
        $uri = $request->getUri();

        // WordPress file upload exploitation
        if (preg_match('/\/wp-content\/uploads\/.*\.(php|phtml|php[3-7]|pht|phar)/i', $path)) {
            $findings[] = 'PHP execution attempt in WordPress uploads directory';
            $maxScore = max($maxScore, 85);
        }

        // WordPress theme editor exploitation
        if (preg_match('/\/wp-admin\/theme-editor\.php/i', $path) && $request->isPost()) {
            $findings[] = 'WordPress theme editor POST (potential webshell injection)';
            $maxScore = max($maxScore, 75);
        }

        // WordPress plugin editor
        if (preg_match('/\/wp-admin\/plugin-editor\.php/i', $path) && $request->isPost()) {
            $findings[] = 'WordPress plugin editor POST (potential code injection)';
            $maxScore = max($maxScore, 75);
        }

        // Admin-ajax.php with suspicious actions
        if (preg_match('/\/wp-admin\/admin-ajax\.php/i', $path)) {
            $action = $request->getQueryParam('action') ?? '';
            $postAction = $request->getPostData()['action'] ?? '';
            $actionValue = $action !== '' ? $action : (is_string($postAction) ? $postAction : '');

            $suspiciousActions = [
                'revslider_show_image',
                'duplicator_download',
                'upload_attach',
                'uploadFontIcon',
                'datafeedr_importProducts',
            ];

            if (in_array(strtolower($actionValue), array_map('strtolower', $suspiciousActions), true)) {
                $findings[] = sprintf('Suspicious admin-ajax action: %s', $actionValue);
                $maxScore = max($maxScore, 80);
            }
        }
    }

    private function checkDrupalSpecific(Request $request, array &$findings, int &$maxScore): void
    {
        $path = $request->getPath();
        $uri = $request->getUri();

        // Drupalgeddon 2 (CVE-2018-7600) specific patterns
        if ($request->isPost() && preg_match('/\/user\/register/i', $path)) {
            $body = $request->getBody();
            if (preg_match('/mail\[.*#.*\]|name\[.*#.*\]/i', $body) || preg_match('/_triggering_element/i', $body)) {
                $findings[] = 'Drupalgeddon 2 exploit attempt (CVE-2018-7600)';
                $maxScore = max($maxScore, 85);
            }
        }

        // Drupal REST API exploitation (CVE-2019-6340)
        if (preg_match('/_format=hal_json/i', $uri)) {
            $contentType = $request->getContentType();
            if ($contentType !== null && str_contains(strtolower($contentType), 'hal+json')) {
                $findings[] = 'Drupal REST API exploitation attempt (CVE-2019-6340)';
                $maxScore = max($maxScore, 80);
            }
        }
    }

    private function checkJoomlaSpecific(Request $request, array &$findings, int &$maxScore): void
    {
        $path = $request->getPath();

        // Joomla com_fields SQL injection (CVE-2017-8917)
        if (preg_match('/\/index\.php.*option=com_fields/i', $request->getUri())) {
            $findings[] = 'Joomla com_fields exploitation attempt (CVE-2017-8917)';
            $maxScore = max($maxScore, 80);
        }

        // Joomla configuration.php access
        if (preg_match('/\/configuration\.php\.(bak|old|orig|txt|save)/i', $path)) {
            $findings[] = 'Joomla configuration backup file probe';
            $maxScore = max($maxScore, 75);
        }
    }

    private function describeExploit(string $pattern): string
    {
        $map = [
            'revslider' => 'Revolution Slider exploit (CVE-2014-9734)',
            'wp-file-manager' => 'WP File Manager exploit (CVE-2020-25213)',
            'duplicator' => 'Duplicator exploit (CVE-2020-11738)',
            'easy-wp-smtp' => 'Easy WP SMTP vulnerability probe',
            'contact-form-7' => 'Contact Form 7 vulnerability probe',
            'uploads\/.*\.php' => 'PHP upload execution attempt',
            'themes\/.*\/404\.php' => 'Theme shell upload target',
            'timthumb' => 'TimThumb exploit',
            'gravityforms' => 'Gravity Forms vulnerability probe',
            'debug\.log' => 'WordPress debug log access',
            'drupalgeddon|user\/register.*ajax|_format=hal_json' => 'Drupalgeddon exploit attempt',
            'sites\/all\/modules' => 'Drupal module scanning',
            'sites\/default\/files' => 'Drupal files directory scanning',
            'com_fabrik' => 'Joomla com_fabrik RCE probe',
            'com_fields' => 'Joomla com_fields SQLi probe (CVE-2017-8917)',
            'libraries\/joomla' => 'Joomla library access attempt',
            'com_media' => 'Joomla com_media exploit probe',
            'readme\.txt|changelog\.txt' => 'CMS plugin version enumeration',
            'dup-installer' => 'Duplicator installer exploit',
        ];

        foreach ($map as $keyword => $description) {
            if (preg_match('/' . $keyword . '/i', $pattern)) {
                return $description;
            }
        }

        return 'CMS plugin/theme exploit probe';
    }

    private function scoreExploit(string $pattern): int
    {
        // Known RCE exploits
        if (preg_match('/wp-file-manager|com_fabrik|drupalgeddon|uploads\/.*\.php/i', $pattern)) {
            return 85;
        }

        // Known data disclosure exploits
        if (preg_match('/revslider|duplicator|debug\.log|dup-installer/i', $pattern)) {
            return 75;
        }

        // SQLi exploits
        if (preg_match('/com_fields/i', $pattern)) {
            return 80;
        }

        // Enumeration/scanning
        if (preg_match('/readme\.txt|changelog\.txt|sites\/all/i', $pattern)) {
            return 60;
        }

        return 65;
    }
}
