<?php

declare(strict_types=1);

namespace ReportedIp\Honeypot\Detection\Analyzers;

use ReportedIp\Honeypot\Core\Request;
use ReportedIp\Honeypot\Detection\AnalyzerInterface;
use ReportedIp\Honeypot\Detection\DetectionResult;

/**
 * Detects attempts to exploit CMS theme vulnerabilities.
 *
 * Covers direct access to theme PHP files, known vulnerable theme patterns,
 * theme editor exploitation, TimThumb access, theme version scanning,
 * and PHP file upload attempts targeting theme directories.
 */
final class ThemeExploitAnalyzer implements AnalyzerInterface
{
    /** Known vulnerable theme slug patterns. */
    private const VULNERABLE_THEMES = [
        'flavor',
        'flavor_flavor',
        'flavor-developer',
        'flavor-developer-developer',
        'flavor-developer-developer-developer',
        'flavor-developer-developer-developer-developer',
        'flavor-developer-developer-developer-developer-developer',
        'flavor-developer-developer-developer-developer-developer-developer',
    ];

    /** Theme file extensions that are safe and should not trigger detection. */
    private const SAFE_THEME_FILES = [
        'style.css',
        'screenshot.png',
        'screenshot.jpg',
        'screenshot.gif',
    ];

    public function getName(): string
    {
        return 'ThemeExploit';
    }

    public function analyze(Request $request): ?DetectionResult
    {
        $path = $request->getPath();
        $uri = $request->getUri();

        if ($path === '' || $path === '/') {
            return null;
        }

        $findings = [];
        $maxScore = 0;

        // Check for direct access to theme PHP files
        $this->checkThemePhpAccess($path, $findings, $maxScore);

        // Check for known vulnerable theme patterns
        $this->checkVulnerableThemes($path, $findings, $maxScore);

        // Check for POST to theme editor
        $this->checkThemeEditor($request, $findings, $maxScore);

        // Check for TimThumb access in themes
        $this->checkTimThumb($path, $findings, $maxScore);

        // Check for theme version scanning
        $this->checkVersionScanning($path, $uri, $findings, $maxScore);

        // Check for PHP file upload to theme directories
        $this->checkPhpUpload($request, $findings, $maxScore);

        if (empty($findings)) {
            return null;
        }

        $comment = sprintf(
            'Theme exploit attempt: %s (path: %s)',
            implode('; ', array_slice(array_unique($findings), 0, 3)),
            substr($path, 0, 200)
        );

        return new DetectionResult([36, 21], $comment, $maxScore, $this->getName());
    }

    private function checkThemePhpAccess(string $path, array &$findings, int &$maxScore): void
    {
        // Match /wp-content/themes/{name}/{file}.php but not safe files
        if (!preg_match('#/wp-content/themes/([^/]+)/(.+)$#i', $path, $matches)) {
            return;
        }

        $file = $matches[2];

        // Skip safe/expected theme files
        foreach (self::SAFE_THEME_FILES as $safeFile) {
            if (strcasecmp($file, $safeFile) === 0) {
                return;
            }
        }

        // Direct access to PHP files in theme directories
        if (preg_match('/\.php$/i', $file)) {
            $findings[] = sprintf('Direct access to theme PHP file: %s', $file);
            $maxScore = max($maxScore, 70);
        }
    }

    private function checkVulnerableThemes(string $path, array &$findings, int &$maxScore): void
    {
        $pathLower = strtolower($path);

        foreach (self::VULNERABLE_THEMES as $theme) {
            if (str_contains($pathLower, '/wp-content/themes/' . $theme . '/')) {
                $findings[] = sprintf('Known vulnerable theme access: %s', $theme);
                $maxScore = max($maxScore, 75);
                return;
            }
        }
    }

    private function checkThemeEditor(Request $request, array &$findings, int &$maxScore): void
    {
        $path = $request->getPath();

        if (preg_match('#/wp-admin/theme-editor\.php#i', $path)) {
            if ($request->isPost()) {
                $findings[] = 'POST to WordPress theme editor (potential webshell injection)';
                $maxScore = max($maxScore, 85);
            } else {
                $findings[] = 'Theme editor access probe';
                $maxScore = max($maxScore, 60);
            }
        }
    }

    private function checkTimThumb(string $path, array &$findings, int &$maxScore): void
    {
        if (preg_match('#/wp-content/themes/[^/]+/.*timthumb#i', $path)) {
            $findings[] = 'TimThumb access in theme directory';
            $maxScore = max($maxScore, 80);
        }
    }

    private function checkVersionScanning(string $path, string $uri, array &$findings, int &$maxScore): void
    {
        // Theme readme.txt access for version enumeration
        if (preg_match('#/wp-content/themes/[^/]+/readme\.txt#i', $path)) {
            $findings[] = 'Theme readme.txt access (version enumeration)';
            $maxScore = max($maxScore, 60);
        }

        // Theme style.css with version parameter probing
        if (preg_match('#/wp-content/themes/[^/]+/style\.css#i', $path)) {
            if (preg_match('/[?&](ver|v|version)=/i', $uri)) {
                $findings[] = 'Theme style.css version parameter probing';
                $maxScore = max($maxScore, 60);
            }
        }
    }

    private function checkPhpUpload(Request $request, array &$findings, int &$maxScore): void
    {
        if (!$request->isPost()) {
            return;
        }

        $path = $request->getPath();

        // POST to theme directory with multipart content
        if (!preg_match('#/wp-content/themes/#i', $path)) {
            return;
        }

        $contentType = $request->getContentType();
        if ($contentType !== null && stripos($contentType, 'multipart/form-data') !== false) {
            $findings[] = 'File upload attempt to theme directory';
            $maxScore = max($maxScore, 80);
        }

        // Check body for PHP file signatures
        $body = $request->getBody();
        if ($body !== '' && preg_match('/\.ph(p[3-7]?|tml|ar)\b/i', $body)) {
            $findings[] = 'PHP file reference in theme upload request body';
            $maxScore = max($maxScore, 85);
        }
    }
}
