<?php

declare(strict_types=1);

namespace ReportedIp\Honeypot\Tests\Analyzers;

use ReportedIp\Honeypot\Detection\Analyzers\PluginExploitAnalyzer;
use ReportedIp\Honeypot\Tests\TestCase;

final class PluginExploitAnalyzerTest extends TestCase
{
    private PluginExploitAnalyzer $analyzer;

    public function setUp(): void
    {
        $this->analyzer = new PluginExploitAnalyzer();
    }

    public function testGetName(): void
    {
        $this->t->assertEquals('PluginExploit', $this->analyzer->getName());
    }

    // --- Positive tests ---

    public function testDetectsRevslider(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/plugins/revslider/temp/update_extract/']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $this->t->assertContains('Revolution Slider', $result->getComment());
    }

    public function testDetectsWpFileManager(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/plugins/wp-file-manager/readme.txt']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsDuplicator(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/plugins/duplicator/installer.php']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsPhpInUploads(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/uploads/2024/01/shell.php']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsDebugLog(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/debug.log']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsPluginReadmeTxt(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/plugins/akismet/readme.txt']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsDupInstaller(): void
    {
        $request = $this->createRequest(['uri' => '/dup-installer/main.installer.php']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    // --- Negative tests ---

    public function testIgnoresNormalWpAssets(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/themes/twentytwentyfour/style.css']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNull($result);
    }

    public function testIgnoresRootPath(): void
    {
        $request = $this->createRequest(['uri' => '/']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNull($result);
    }

    public function testIgnoresNormalPage(): void
    {
        $request = $this->createRequest(['uri' => '/hello-world/']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNull($result);
    }

    public function testCategoriesAre35And57(): void
    {
        $request = $this->createRequest(['uri' => '/wp-content/plugins/revslider/']);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $categories = $result->getCategories();
        $this->t->assertTrue(in_array(35, $categories, true), 'Should include category 35');
        $this->t->assertTrue(in_array(57, $categories, true), 'Should include category 57');
    }
}
